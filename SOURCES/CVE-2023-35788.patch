From 82bbdd274a50ab8d3e2c172ff871ce6247a7a533 Mon Sep 17 00:00:00 2001
From: Ryan Sullivan <rysulliv@redhat.com>
Date: Fri, 7 Jul 2023 09:35:18 -0400
Subject: [KPATCH CVE-2023-35788] kpatch fixes for CVE-2023-35788

Kernels:
5.14.0-284.11.1.el9_2
5.14.0-284.18.1.el9_2


Kpatch-MR: https://gitlab.com/redhat/prdsc/rhel/src/kpatch/rhel-9/-/merge_requests/38
Approved-by: Joe Lawrence (@joe.lawrence)
Changes since last build:
arches: x86_64 ppc64le
cls_flower.o: changed function: fl_set_geneve_opt.constprop.0
ipvlan_core.o: changed function: ipvlan_xmit_mode_l3
ipvlan_core.o: new function: ipvlan_process_v4_outbound
ipvlan_core.o: new function: ipvlan_process_v6_outbound
---------------------------

Modifications: none

commit 51b0ae3b0b167dafa1c79d1fcd18aa4e66ef75ad
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Tue Jun 20 12:23:04 2023 +0200

    net/sched: flower: fix possible OOB write in fl_set_geneve_opt()

    Bugzilla: https://bugzilla.redhat.com/2216991
    CVE: CVE-2023-35788
    Y-Commit: 45f7226824fa92fa531eb46e53a2966751f2f90a

    O-Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=2214029
    Upstream Status: net.git commit 4d56304e5827
    O-CVE: CVE-2023-35788

    commit 4d56304e5827c8cc8cc18c75343d283af7c4825c
    Author: Hangyu Hua <hbh25y@gmail.com>
    Date:   Wed May 31 18:28:04 2023 +0800

        net/sched: flower: fix possible OOB write in fl_set_geneve_opt()

        If we send two TCA_FLOWER_KEY_ENC_OPTS_GENEVE packets and their total
        size is 252 bytes(key->enc_opts.len = 252) then
        key->enc_opts.len = opt->length = data_len / 4 = 0 when the third
        TCA_FLOWER_KEY_ENC_OPTS_GENEVE packet enters fl_set_geneve_opt. This
        bypasses the next bounds check and results in an out-of-bounds.

        Fixes: 0a6e77784f49 ("net/sched: allow flower to match tunnel options")
        Signed-off-by: Hangyu Hua <hbh25y@gmail.com>
        Reviewed-by: Simon Horman <simon.horman@corigine.com>
        Reviewed-by: Pieter Jansen van Vuuren <pieter.jansen-van-vuuren@amd.com>
        Link: https://lore.kernel.org/r/20230531102805.27090-1-hbh25y@gmail.com
        Signed-off-by: Paolo Abeni <pabeni@redhat.com>

    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: Herton R. Krzesinski <herton@redhat.com>

Signed-off-by: Ryan Sullivan <rysulliv@redhat.com>
---
 net/sched/cls_flower.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/net/sched/cls_flower.c b/net/sched/cls_flower.c
index 041d63ff809a..65b68bf36b92 100644
--- a/net/sched/cls_flower.c
+++ b/net/sched/cls_flower.c
@@ -1145,6 +1145,9 @@ static int fl_set_geneve_opt(const struct nlattr *nla, struct fl_flow_key *key,
 	if (option_len > sizeof(struct geneve_opt))
 		data_len = option_len - sizeof(struct geneve_opt);
 
+	if (key->enc_opts.len > FLOW_DIS_TUN_OPTS_MAX - 4)
+		return -ERANGE;
+
 	opt = (struct geneve_opt *)&key->enc_opts.data[key->enc_opts.len];
 	memset(opt, 0xff, option_len);
 	opt->length = data_len / 4;
-- 
2.40.1


